---
title: "Reisehäufigkeit"
author: "Alexander Bauer, Maximilian Weigert"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    number_sections: yes
    code_folding: hide
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(APCtools)
library(tidyverse)
theme_set(theme_minimal())
library(mgcv)
library(pROC)

# read and prepare the data
source("../0_helpers/1_dataPrep.R")
dat_model <- read_and_prepare_data(user = "Alex", model = "frequency")
```

# Datenaufbereitung

##### Herangehensweise Zielgröße (Anzahl der Urlaubsreisen) 

```{r}
dat_model %>%
  mutate(period = factor(period)) %>%
  ggplot(aes(period, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))
```

#Verteilung der Anzahl der Reisen 
```{r}
dat_model %>% 
  mutate(JS_Anzahl_URs = factor(JS_Anzahl_URs)) %>% 
  ggplot(aes(as.factor(period), fill = JS_Anzahl_URs)) +
  geom_bar(position = "fill")
```


#Model
```{r}
# Function in order to estimate a pure APC model:

# Model '2+ URs' vs '1 UR'
model <- bam(y_atLeastTwoURs ~ te(period, age, k = c(10, 10), bs = "ps"),
             family = binomial(link = "logit"), data = dat_model)
model_L <- bam(y_atLeastTwoURs ~ te(period, age, k = c(10, 10), bs = "ps") +
                 S_Geschlecht + S_Kinder_0_bis_5_binaer + S_Wohnortgroesse + S_Bildung_HV +
                 s(S_Einkommen_HH_equi, bs = "ps", k = 10) + S_Haushaltsgroesse,
               family = binomial(link = "logit"), data = dat_model)
summary(model_L)
```


##### Zielgröße vs. Periode

```{r}
dat_model %>% 
  mutate(period = factor(period)) %>% 
  ggplot(aes(period, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

dat_model %>% 
  mutate(period = factor(period)) %>% 
  ggplot(aes(period, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0,3))
```



##### Zielgröße vs. Alter des Hauptverdieners im HH
```{r}
dat_model %>% 
  mutate(age = factor(age)) %>% 
  ggplot(aes(age, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

dat_model %>% 
  mutate(age = factor(age)) %>% 
  ggplot(aes(age, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0,3))
```


##### Zielgröße vs. Geschlecht

```{r}
dat_model %>% 
  ggplot(aes(S_Geschlecht, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

dat_model %>% 
  ggplot(aes(S_Geschlecht, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0,3))
```


##### Zielgröße vs. ob Kleinkinder (<= 5 Jahre) im Haushalt leben

```{r}
dat_model %>% 
  ggplot(aes(S_Kinder_0_bis_5_binaer, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

dat_model %>% 
  ggplot(aes(S_Kinder_0_bis_5_binaer, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0,3))
```

##### Zielgröße vs. Wohnortgröße
```{r}
dat_model %>% 
  ggplot(aes(S_Wohnortgroesse, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

dat_model %>% 
  ggplot(aes(S_Wohnortgroesse, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0,3))
```

##### Zielgröße vs. Bildung des Hauptverdieners

```{r}
dat_model %>% 
  ggplot(aes(S_Bildung_HV, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

dat_model %>% 
  ggplot(aes(S_Bildung_HV, JS_Anzahl_URs)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0,3))
```


##### Zielgröße vs. personen-adjustiertem HH-Einkommen

```{r}
ggplot(dat_model, aes(S_Einkommen_HH_equi, JS_Anzahl_URs)) +
  geom_hex()
```

##### Zielgröße vs. insgesamt mitgereisten Personen

```{r}
ggplot(dat_model, aes(JS_HUR_Reisebegleitung_Gesamtanzahl, JS_Anzahl_URs)) +
  geom_hex()
```


##### Heatmap of APC surface

```{r}
plot_APCheatmap(dat = dat_model, model = model, plot_CI = FALSE)

model_list <- list("Pure APC model"  = model,
                   "Covariate model" = model_L)
plot_jointMarginalAPCeffects(model_list, dat_model)

# Partial APC plots
plot_partialAPCeffects(model, dat_model, variable = "age")
plot_partialAPCeffects(model, dat_model, variable = "period")
plot_partialAPCeffects(model, dat_model, variable = "cohort")

# Partial APC plots (incl. Covariables)
plot_partialAPCeffects(model_L, dat_model, variable = "age")
plot_partialAPCeffects(model_L, dat_model, variable = "period")
plot_partialAPCeffects(model_L, dat_model, variable = "cohort")
```


##### Effects of further covariates

```{r}
plot(model, select = 2, rug = TRUE)
```



##### Modellevaluation 

```{r}
set.seed(3456)

# Splitting the data into training and test data:
train_index <- sample(1:nrow(dat_model), 0.8 * nrow(dat_model))
dat_train <- dat_model[train_index, ]
dat_test <- dat_model[-train_index, ]

# Model estimation:
model_pure <- bam(y_atLeastTwoURs ~ te(period, age, k = c(10, 10), bs = "ps"),
                  family = binomial(link = "logit"), data = dat_train)
  
# Computation of AUC:
prediction <- predict(object = model_pure, newdata = dat_test)
auc <- suppressMessages(roc(dat_test$y_atLeastTwoURs, prediction))
auc 
```

##### Modellevaluation (incl. Covariables)

```{r}
# Model estimation:
model_covariate <- bam(y_atLeastTwoURs ~ te(period, age, k = c(10, 10), bs = "ps") +
                         S_Geschlecht + S_Kinder_0_bis_5_binaer + S_Wohnortgroesse + S_Bildung_HV +
                         s(S_Einkommen_HH_equi, bs = "ps", k = 10) + S_Haushaltsgroesse,
                       family = binomial(link = "logit"), data = dat_train)
  
# Computation of AUC:
prediction <- predict(object = model_covariate, newdata = dat_test)
auc <- suppressMessages(roc(dat_test$y_atLeastTwoURs, prediction))
auc 
```
